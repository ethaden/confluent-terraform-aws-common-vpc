# Share VPC using Terraform Remote State in S3
This terraform configuration sets up a Terraform S3 remote state for shared resources.

CAUTION: Everything contained in this repository is not supported by Confluent.

Note, that additional measures (e.g. locking) might be required if this state store is accessed concurrently by multiple users.

You can find a configuration to set up the Terraform S3 remote state bucket here: https://github.com/ethaden/confluent-terraform-aws-tfstate-s3.

## Precondition
Obviously, you need to have an AWS account with proper credentials set up.

## Usage

### Terraform Setup
First you might want to customize `variables.tf` or create a local file `terraform.tfvars` where you set values for certain variables.
This configuration re-uses a common network setup available via a Terraform S3 remote state. This needs to be set up first.

Then you just run terraform and look at the plan (optional step):

```bash
terraform plan
```

Execute the plan by running:

```bash
terraform apply
```

You can delete the generated resources by running:

```bash
terraform destroy
```

However, as deleting a used terraform remote state might have devestating consequences, I blocked deletion by default by setting the lifecycle variable `prevent_destroy=true`. If you really want to delete the storage using terraform, set these variables to `false` first.

### AWS Client VPN via OpenVPN
This configuration creates an AWS Client VPN endpoint with a Certificate Authority, one server certificate and (by default) one client certificate. More client certificates can be generated by changing the default values in the Terraform variables (please have a look at [Variables.tf], I you want to overwrite variables I rcommend using a tfvars file).

#### OpenVPN Clients
There is an official AWS VPN Client, but every OpenVPN Client (community edition) should work. On MacOS, the open-source software [tunnelblick](https://tunnelblick.net/) is a very good choice and which is also referenced on the AWS websites.

#### Customizing OpenVPN Client Settings: IPv4/IPv6 Dualstack Split Tunneling
By default, this configuration uses a split tunnel, i.e. only network traffic designated for the AWS VPC Subnets will go through the tunnel, other traffic will just use your regular internet connection. However, AWS Client VPN currently supports only the IPv4 protocol. If you use a IPv4/IPv6 dualstack configuration at your workplace/at home, you might experience issues with IPv6 as soon as you connect to the VPN endpoint: Some VPN clients (e.g. `tunnelblick`) disable IPv6 automatically when establishing the VPN tunnel. But, you can change this behavior in your client settings.

#### Customizing OpenVPN Client Settings: VPC DNS
The OpenVPN client might refuse to configure DNS servers provided by the Client VPN Server if it assumes that DNS servers on your machine have been configured manually (even if that is not the case). You might need to override this behavior in your client settings. For example in `tunnelblick` there is an advanced setting which allows the client to change network settings such as DNS even if it detects manually specified network settings.

## DISCLAIMER
THIS CONFIGURATION IS MEANT FOR TESTING ONLY AND NOT FOR PRODUCTION. PLEASE CHECK THE [LICENSE](LICENSE) FOR FURTHER INFORMATION.

